# -*- coding: utf-8 -*-
"""Manga_Project_01.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1DiQvqxIUq8F747laECxPotEJu7u_wlxA
"""

import streamlit as st
import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import linear_kernel
import ast
import math
import csv
import os
import base64
from datetime import datetime

# --- PAGE CONFIGURATION ---
st.set_page_config(page_title="MangaRK", page_icon="üìö", layout="wide")

# --- PREMIUM NEXT-GEN CSS ---
st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap');

    /* --- NEW BACKGROUND COLOR --- */
    .stApp {
        background-color: #0f172a; /* Deep Slate/Navy Blue */
    }

    html, body, [class*="css"] {
        font-family: 'Poppins', sans-serif;
    }
    .block-container {
        padding-top: 0rem !important;
        padding-bottom: 0rem !important;
    }
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
    header {visibility: hidden;}

    /* Base Hero Header Styling (Background image gets injected dynamically below) */
    .hero-container {
        padding: 4rem 0 3.5rem 0;
        text-align: center;
        background-color: #1a202c; /* Fallback color */
        border-radius: 0 0 30px 30px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        border-bottom: 2px solid #ff4b4b;
    }

    .main-header {
        background: linear-gradient(135deg, #ff4b4b, #ff8c00);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 3.5rem;
        font-weight: 800;
        margin-bottom: 0px;
        padding-bottom: 0px;
        text-transform: uppercase;
        letter-spacing: 2px;
    }
    .sub-header {
        color: #e2e8f0;
        font-size: 1.2rem;
        font-weight: 300;
        margin-top: 5px;
    }

    .manga-poster {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: #1a202c;
        margin-bottom: 15px;
    }
    .manga-poster:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 30px rgba(255, 75, 75, 0.3);
    }
    .manga-img {
        width: 100%;
        height: 340px;
        object-fit: cover;
        display: block;
    }

    .manga-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, rgba(15, 23, 42, 1) 0%, rgba(15, 23, 42, 0.8) 60%, transparent 100%);
        padding: 20px 12px 10px 12px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
    }
    .manga-title {
        color: #ffffff;
        font-size: 15px;
        font-weight: 600;
        margin: 0;
        line-height: 1.2;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .manga-stats {
        color: #fbbf24;
        font-size: 12px;
        font-weight: 600;
        margin-top: 5px;
    }

    .stTabs [data-baseweb="tab-list"] {
        gap: 24px;
        justify-content: center;
    }
    .stTabs [data-baseweb="tab"] {
        height: 50px;
        white-space: pre-wrap;
        border-radius: 8px 8px 0 0;
        padding-top: 10px;
        padding-bottom: 10px;
        font-size: 16px;
        font-weight: 600;
    }
    </style>
""", unsafe_allow_html=True)

# --- HEADER SECTION WITH DYNAMIC LOCAL IMAGE ---
def get_base64(file_path):
    try:
        with open(file_path, "rb") as f:
            data = f.read()
        return base64.b64encode(data).decode()
    except FileNotFoundError:
        return ""

bg_image = get_base64("naruto_bg.jpg")

if bg_image:
    st.markdown(f"""
        <style>
        .hero-container {{
            padding: 8rem 0 7rem 0 !important; /* Makes the banner much taller */
            background: linear-gradient(rgba(15, 23, 42, 0.70), rgba(15, 23, 42, 0.95)),
                        url('data:image/jpeg;base64,{bg_image}') !important;
            background-size: cover !important;
            background-position: center 30% !important;
        }}
        </style>
    """, unsafe_allow_html=True)
else:
    current_folder = os.getcwd()
    st.error(f"üö® **Image not found!** Python is looking for 'naruto_bg.jpg' exactly inside this folder: `{current_folder}`")
    st.info("Make sure you drag and drop your image into that exact folder listed above, and make sure it isn't accidentally named 'naruto_bg.jpg.jpg'!")

st.markdown('''
    <div class="hero-container">
        <div class="main-header">WELCOME TO MANGARK</div>
        <p class="sub-header">Discover, track, and curate your ultimate manga collection.</p>
    </div>
''', unsafe_allow_html=True)

# --- COLOR DICTIONARY FOR TAGS ---
TAG_COLORS = {
    'Action': '#ef4444', 'Romance': '#ec4899', 'Horror': '#991b1b',
    'Sci Fi': '#3b82f6', 'Comedy': '#f59e0b', 'Drama': '#8b5cf6',
    'Fantasy': '#10b981', 'Slice of Life': '#84cc16', 'Mystery': '#6366f1',
    'Shounen': '#f97316', 'Shoujo': '#f43f5e', 'Seinen': '#b91c1c',
    'Josei': '#d946ef', 'Adventure': '#0ea5e9', 'Supernatural': '#8b5cf6',
    'Psychological': '#64748b', 'Sports': '#ea580c', 'Historical': '#b45309'
}

def get_tag_html(tag):
    color = TAG_COLORS.get(tag, '#475569')
    return f"<span style='background-color: {color}20; color: {color}; border: 1px solid {color}50; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-right: 4px; display: inline-block; margin-bottom: 4px; font-weight: 600; letter-spacing: 0.5px;'>{tag.upper()}</span>"

# --- INITIALIZE SESSION STATE ---
if 'reading_list' not in st.session_state:
    st.session_state.reading_list = {}
if 'random_manga' not in st.session_state:
    st.session_state.random_manga = pd.DataFrame()
if 'current_page' not in st.session_state:
    st.session_state.current_page = 1
if 'last_filters' not in st.session_state:
    st.session_state.last_filters = None

def toggle_list(manga_dict):
    title = manga_dict['title']
    if title in st.session_state.reading_list:
        del st.session_state.reading_list[title]
    else:
        st.session_state.reading_list[title] = manga_dict

# --- 1. LOAD DATA ---
@st.cache_data
def load_data():
    try:
        df = pd.read_csv("Manga_data.csv.gz", compression="gzip")
    except FileNotFoundError:
        st.error("Manga_data.csv not found. Please upload it.")
        return pd.DataFrame()

    df['description'] = df['description'].fillna("No synopsis available for this title.")
    df['rating'] = df['rating'].fillna(0)
    df['year'] = pd.to_numeric(df['year'], errors='coerce').fillna(0)

    placeholder_img = "https://via.placeholder.com/300x450.png?text=Cover+Not+Found"
    df['cover'] = df['cover'].fillna(placeholder_img)

    def get_tag_list(tag_str):
        try:
            return ast.literal_eval(tag_str)
        except:
            return []

    def process_tags(tag_str):
        tags = get_tag_list(tag_str)
        return " ".join([str(t).replace(" ", "_") for t in tags])

    df['processed_tags'] = df['tags'].apply(process_tags)
    df['tag_list'] = df['tags'].apply(get_tag_list)

    # AI now reads Title + Tags + Description!
    df['combined_features'] = df['title'].astype(str) + " " + df['processed_tags'] + " " + df['description']

    return df

df = load_data()

# --- 2. COMPUTE TF-IDF MATRIX ---
@st.cache_resource
def compute_tfidf(data):
    # max_features removed so AI learns every word!
    tfidf = TfidfVectorizer(stop_words='english')
    matrix = tfidf.fit_transform(data['combined_features'])
    return tfidf, matrix

if not df.empty:
    tfidf_model, tfidf_matrix = compute_tfidf(df)

    all_tags = set()
    for tags in df['tag_list']:
        all_tags.update(tags)
    all_tags = sorted(list(all_tags))

    # --- HELPER FUNCTION: CINEMATIC GRID LAYOUT ---
    def display_manga_grid(dataframe, key_prefix):
        if dataframe.empty:
            st.warning("No manga found matching your criteria.")
            return

        for i in range(0, len(dataframe), 5):
            cols = st.columns(5)
            row_slice = dataframe.iloc[i:i+5]

            for col, (_, row) in zip(cols, row_slice.iterrows()):
                with col:
                    year_val = int(row['year']) if row['year'] else 'N/A'

                    html_poster = f'''
                    <div class="manga-poster">
                        <img class="manga-img" src="{row["cover"]}" referrerpolicy="no-referrer"
                        onerror="this.onerror=null;this.src='https://via.placeholder.com/300x450.png?text=Cover+Not+Found';">
                        <div class="manga-overlay">
                            <h4 class="manga-title">{row['title']}</h4>
                            <div class="manga-stats">‚≠ê {row['rating']} &nbsp;|&nbsp; üìÖ {year_val}</div>
                        </div>
                    </div>
                    '''
                    st.markdown(html_poster, unsafe_allow_html=True)

                    top_tags = row['tag_list'][:3]
                    if top_tags:
                        tags_html = "".join([get_tag_html(tag) for tag in top_tags])
                        st.markdown(f"<div style='margin-bottom: 5px;'>{tags_html}</div>", unsafe_allow_html=True)

                    # Add to Library Button
                    in_list = row['title'] in st.session_state.reading_list
                    btn_text = "‚úì In Library" if in_list else "‚ûï Add to Library"
                    btn_type = "secondary" if in_list else "primary"
                    st.button(
                        btn_text,
                        key=f"{key_prefix}_{row['title']}",
                        on_click=toggle_list,
                        args=(row.to_dict(),),
                        type=btn_type,
                        use_container_width=True
                    )

                    # Where to Read Button (Dynamic Google Search)
                    formatted_title = str(row['title']).replace(' ', '+')
                    search_url = f"https://www.google.com/search?q=where+to+read+{formatted_title}+manga+official"
                    st.link_button("üåê Where to Read", search_url, use_container_width=True)

                    with st.expander("üìù Synopsis"):
                        st.write(row['description'])

            st.write("<br>", unsafe_allow_html=True)

    # --- UI LAYOUT TABS ---
    tab1, tab2, tab3, tab4, tab5 = st.tabs([
        "üß≠ Browse & Search",
        "‚ú® AI Recommendations",
        "üé≤ Random Roll",
        f"üìö Library ({len(st.session_state.reading_list)})",
        "üì¨ Feedback"
    ])

    # --- TAB 1: BROWSE & SEARCH ---
    with tab1:
        st.markdown("### üîç Search & Filters")

        search_query = st.text_input("Search Catalog:", placeholder="Type a manga title (e.g., Solo Leveling)...", key="browse_search")

        f_col1, f_col2 = st.columns(2)
        with f_col1:
            include_tags = st.multiselect("‚úÖ Must Include Genres:", all_tags, key="browse_inc_tags")
        with f_col2:
            exclude_tags = st.multiselect("üö´ Must NOT Include Genres:", all_tags, key="browse_exc_tags")

        f_col3, f_col4, f_col5 = st.columns(3)
        with f_col3:
            min_rating = st.slider("Minimum Rating", 0.0, 5.0, 4.0, 0.1, key="browse_rating")
        with f_col4:
            years = st.slider("Release Year Range", 1950, 2024, (2000, 2024), key="browse_years")
        with f_col5:
            sort_by = st.selectbox("Sort Results By:", ["Highest Rated", "Newest", "Oldest", "A-Z"], key="browse_sort")

        st.markdown("---")

        current_filters = (search_query, tuple(include_tags), tuple(exclude_tags), min_rating, tuple(years), sort_by)
        if st.session_state.last_filters != current_filters:
            st.session_state.current_page = 1
            st.session_state.last_filters = current_filters

        filtered = df[
            (df['rating'] >= min_rating) &
            (df['year'] >= years[0]) &
            (df['year'] <= years[1])
        ]

        if search_query:
            filtered = filtered[filtered['title'].str.contains(search_query, case=False, na=False)]
        if include_tags:
            filtered = filtered[filtered['tag_list'].apply(lambda x: all(t in x for t in include_tags))]
        if exclude_tags:
            filtered = filtered[filtered['tag_list'].apply(lambda x: not any(t in x for t in exclude_tags))]

        if sort_by == "Highest Rated":
            filtered = filtered.sort_values(by='rating', ascending=False)
        elif sort_by == "Newest":
            filtered = filtered.sort_values(by='year', ascending=False)
        elif sort_by == "Oldest":
            filtered = filtered.sort_values(by='year', ascending=True)
        elif sort_by == "A-Z":
            filtered = filtered.sort_values(by='title', ascending=True)

        ITEMS_PER_PAGE = 30
        total_results = len(filtered)
        total_pages = math.ceil(total_results / ITEMS_PER_PAGE) if total_results > 0 else 1

        if st.session_state.current_page > total_pages:
            st.session_state.current_page = total_pages

        start_idx = (st.session_state.current_page - 1) * ITEMS_PER_PAGE
        end_idx = start_idx + ITEMS_PER_PAGE
        paginated_res = filtered.iloc[start_idx:end_idx]

        if total_results > 0:
            st.markdown(f"<p style='color: #a0aec0; text-align: right;'>Showing page {st.session_state.current_page} of {total_pages} ({total_results} results)</p>", unsafe_allow_html=True)

        display_manga_grid(paginated_res, key_prefix="browse")

        if total_pages > 1:
            st.write("---")
            p_col1, p_col2, p_col3 = st.columns([1, 2, 1])
            with p_col1:
                if st.button("‚Üê Previous", disabled=(st.session_state.current_page == 1), use_container_width=True, key="prev_btn"):
                    st.session_state.current_page -= 1
                    st.rerun()
            with p_col2:
                st.markdown(f"<div style='text-align: center; font-size: 16px; font-weight: bold; color: #ff4b4b; padding-top: 5px;'>Page {st.session_state.current_page}</div>", unsafe_allow_html=True)
            with p_col3:
                if st.button("Next ‚Üí", disabled=(st.session_state.current_page == total_pages), use_container_width=True, key="next_btn"):
                    st.session_state.current_page += 1
                    st.rerun()

    # --- TAB 2: RECOMMENDATIONS ---
    with tab2:
        st.markdown("<h4 style='color: #ff4b4b;'>‚ú® Choose how the AI finds your next read:</h4>", unsafe_allow_html=True)

        rec_mode = st.radio("Recommendation Mode:", ["Pick an Existing Manga", "Type a Keyword or Plot Idea"], horizontal=True, label_visibility="collapsed", key="ai_mode_radio")
        st.markdown("<br>", unsafe_allow_html=True)

        if rec_mode == "Pick an Existing Manga":
            col1, col2 = st.columns([3, 1])
            with col1:
                manga_titles = df['title'].dropna().unique().tolist()
                selected_manga = st.selectbox("Select a base manga for AI matching:", [""] + manga_titles, key="ai_select_base")
            with col2:
                num_recs = st.slider("Results", 1, 100, 10, key="ai_slider_exact")

            if selected_manga:
                idx = df.index[df['title'] == selected_manga].tolist()[0]
                cosine_sim = linear_kernel(tfidf_matrix[idx], tfidf_matrix).flatten()
                sim_indices = cosine_sim.argsort()[:-num_recs-2:-1][1:]
                recs = df.iloc[sim_indices]

                st.markdown(f"### Titles similar to **{selected_manga}**:")
                display_manga_grid(recs, key_prefix="rec_exact")

                export_recs = recs[['title', 'rating', 'year', 'tags', 'description', 'cover']].copy()
                export_recs['Cover Preview'] = export_recs['cover'].apply(lambda x: f'=IMAGE("{x}")')
                csv_data_recs = export_recs.to_csv(index=False).encode('utf-8')

                st.download_button("üì• Export Recommendations to CSV", data=csv_data_recs, file_name=f"Recs_{selected_manga}.csv", mime="text/csv", key="ai_download_exact")

        else:
            col1, col2 = st.columns([3, 1])
            with col1:
                user_query = st.text_input("What are you in the mood for?", placeholder="e.g., Pokemon, magic school, cyberpunk ninja...", key="ai_text_query")
            with col2:
                num_recs = st.slider("Results", 1, 100, 10, key="ai_slider_custom")

            if user_query:
                query_vec = tfidf_model.transform([user_query])

                if query_vec.nnz == 0:
                    st.warning(f"ü§î The AI doesn't recognize the exact words '{user_query}'. Try describing the plot (e.g., 'ninja', 'vampire romance') or check your spelling!")
                else:
                    cosine_sim = linear_kernel(query_vec, tfidf_matrix).flatten()
                    sim_indices = cosine_sim.argsort()[::-1]
                    valid_indices = [i for i in sim_indices if cosine_sim[i] > 0.0]

                    if not valid_indices:
                        st.info("No strong matches found for those specific keywords. Try generalizing your search!")
                    else:
                        recs = df.iloc[valid_indices[:num_recs]]

                        st.markdown(f"### Best AI matches for: **'{user_query}'**")
                        display_manga_grid(recs, key_prefix="rec_custom")

                        export_recs = recs[['title', 'rating', 'year', 'tags', 'description', 'cover']].copy()
                        export_recs['Cover Preview'] = export_recs['cover'].apply(lambda x: f'=IMAGE("{x}")')
                        csv_data_recs = export_recs.to_csv(index=False).encode('utf-8')

                        st.download_button("üì• Export Recommendations to CSV", data=csv_data_recs, file_name=f"Recs_Custom_Query.csv", mime="text/csv", key="ai_download_custom")

    # --- TAB 3: SURPRISE ME ---
    with tab3:
        st.markdown("<div style='text-align: center; padding: 2rem;'><h3 style='color: #ff4b4b;'>Let the algorithm decide.</h3></div>", unsafe_allow_html=True)

        roll_count = st.slider("How many random manga do you want?", 5, 50, 10, key="rand_slider")

        if st.button(f"üé≤ Roll {roll_count} Random Top-Tier Manga!", use_container_width=True, key="rand_btn"):
            st.session_state.random_manga = df[df['rating'] >= 4.2].sample(roll_count)

        if not st.session_state.random_manga.empty:
            st.write("<br>", unsafe_allow_html=True)
            display_manga_grid(st.session_state.random_manga, key_prefix="rand")

    # --- TAB 4: READING LIST ---
    with tab4:
        if not st.session_state.reading_list:
            st.info("Your library is currently empty. Start browsing to add titles!")
        else:
            list_df = pd.DataFrame(list(st.session_state.reading_list.values()))

            export_df = list_df[['title', 'rating', 'year', 'tags', 'description', 'cover']].copy()
            export_df['Cover Preview'] = export_df['cover'].apply(lambda x: f'=IMAGE("{x}")')
            csv_data = export_df.to_csv(index=False).encode('utf-8')

            col_a, col_b, col_c = st.columns([1, 2, 1])
            with col_a:
                st.download_button("üì• Export Library", data=csv_data, file_name="MangaRK_Library.csv", mime="text/csv", use_container_width=True, key="lib_download")
            with col_c:
                if st.button("üóëÔ∏è Clear Library", type="secondary", use_container_width=True, key="lib_clear"):
                    st.session_state.reading_list = {}
                    st.rerun()

            st.write("<br>", unsafe_allow_html=True)
            display_manga_grid(list_df, key_prefix="list")

    # --- TAB 5: FEEDBACK & REQUESTS ---
    with tab5:
        st.markdown("<h3 style='color: #ff4b4b;'>üì¨ Help us improve MangaRK</h3>", unsafe_allow_html=True)
        st.markdown("Is your favorite manga missing from our database? Did you spot a broken image or incorrect rating? Let us know!")

        col_form, col_empty = st.columns([2, 1])

        with col_form:
            with st.form("feedback_form"):
                feedback_type = st.selectbox(
                    "What is this regarding?",
                    ["Request Missing Manga", "Report Broken Image", "Incorrect Data/Tags", "Feature Suggestion", "Other Bug"],
                    key="feed_type"
                )

                manga_name = st.text_input("Manga Title (if applicable)", placeholder="e.g., Kagurabachi", key="feed_title")

                message = st.text_area(
                    "Details / Links",
                    placeholder="Please provide any relevant details, synopsis, or links to the poster image here...",
                    key="feed_msg"
                )

                submitted = st.form_submit_button("üì§ Submit to Admin", use_container_width=True)

                if submitted:
                    if len(message) < 5 and feedback_type != "Request Missing Manga":
                        st.error("‚ö†Ô∏è Please provide a little more detail in the details box.")
                    elif not manga_name and feedback_type == "Request Missing Manga":
                        st.error("‚ö†Ô∏è Please provide the name of the missing manga.")
                    else:
                        file_exists = os.path.isfile("user_feedback.csv")

                        with open("user_feedback.csv", "a", newline="", encoding="utf-8") as f:
                            writer = csv.writer(f)
                            if not file_exists:
                                writer.writerow(["Timestamp", "Type", "Manga Title", "Message"])
                            writer.writerow([datetime.now().strftime("%Y-%m-%d %H:%M:%S"), feedback_type, manga_name, message])

                        st.success("üéâ Thank you! Your submission has been received and saved to our database.")

        # --- SECURE ADMIN SECTION ---
        if os.path.isfile("user_feedback.csv"):
            st.markdown("---")
            st.markdown("<h5 style='color: #a0aec0;'>‚öôÔ∏è Admin Panel (Restricted Access)</h5>", unsafe_allow_html=True)

            admin_password = st.text_input("Enter Admin Password:", type="password", key="admin_pass")

            if admin_password == "manga_admin_2026":
                with open("user_feedback.csv", "rb") as f:
                    admin_csv = f.read()

                col_down, col_del = st.columns([1, 1])
                with col_down:
                    st.download_button(
                        label="üì• Download User Feedback CSV",
                        data=admin_csv,
                        file_name="user_feedback.csv",
                        mime="text/csv",
                        use_container_width=True,
                        key="admin_download"
                    )
                with col_del:
                    if st.button("üóëÔ∏è Delete Server File", type="secondary", use_container_width=True, key="admin_del"):
                        os.remove("user_feedback.csv")
                        st.success("File deleted from server!")
                        st.rerun()

            elif admin_password != "":
                st.error("‚ùå Incorrect Password.")

